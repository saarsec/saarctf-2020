import json
import urllib

from saarlendar import Remote, now


def finduser1(r, limit=25):
    # r.VERBOSE = r.DEBUG
    t = int(now())
    usernames = []
    for off in range(limit):
        e1 = r.getevents(timestamp=str(t - off).encode(), public=True)
        for e in e1:
            try:
                e = json.loads(e)
                if "spare flags" in urllib.parse.unquote_plus(e["text"]):
                    usernames += [(urllib.parse.unquote_plus(e["creator"]).encode(), str(t - off).encode())]
            except:
                pass
    print(usernames)
    return usernames


def dump_events(r, limit=25):
    t = int(now())
    usernames = []
    for off in range(limit):
        e1 = r.getevents(timestamp=str(t - off).encode())
        for event in e1:
            try:
                e = json.loads(event)
                print(urllib.parse.unquote_plus(e["text"]))
            except:
                pass


def finduser2(r):
    t = int(now())
    usernames = []
    m1 = r.shell_getmessages(shell=Remote.xored_message_shell)
    for m in m1:
        try:
            m = json.loads(m)
            text = urllib.parse.unquote_plus(m["text"])
            if (text.startswith("Can you invite me")):
                return m["from"]
        except:
            continue
    return None
